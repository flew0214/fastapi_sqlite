# 🚀 多聊天室频道功能使用指南

---

## 问题修复说明

### 问题1：消息发送成功但界面上没有反应
**原因：** 后端广播消息格式增加了频道参数，但前端仍按旧格式解析

**修复：**
- 后端广播格式：`NEW_MESSAGE:username:content:time:channel`
- 前端现在正确解析5个部分，并只显示当前频道的消息

### 问题2：不知道如何增加频道
**修复：** 添加了直观的"添加频道"按钮

---

## 使用说明

### 1. 切换频道

聊天界面右上角（用户名旁边）有频道选择器：

```
💬 聊天室                    [频道选择器▼] 👤 用户名 [清空] [退出]
```

**操作步骤：**
1. 点击频道选择器下拉框
2. 从列表中选择一个频道
3. 系统自动切换到该频道
4. 消息列表清空，加载新频道的历史消息

### 2. 创建新频道

在频道选择器旁边有一个➕按钮

**操作步骤：**
1. 点击 ➕ 按钮
2. 弹出"添加新频道"对话框
3. 输入频道名称（如：技术讨论、生活分享、工作群）
4. 点击"创建"或按回车
5. 系统自动切换到新频道
6. 发送第一条消息激活频道

### 3. 频道规则

- **默认频道**：所有用户默认进入，名为 "default"
- **临时频道**：直接输入任意名称即可创建
- **频道隔离**：每个频道的消息完全独立，互不干扰
- **用户共享**：不同频道可以有相同的用户
- **频道列表**：显示所有有消息的频道 + 默认频道

### 4. 消息显示规则

- 你只能看到**当前频道**的消息
- 切换频道后，之前频道的消息自动隐藏
- 你的消息发送到**当前选中**的频道

---

## 工作流程示例

### 场景：创建团队频道并讨论

1. **登录系统**
   - 进入默认频道

2. **创建"团队讨论"频道**
   - 点击 ➕ 按钮
   - 输入 "团队讨论"
   - 点击创建
   - 系统切换到新频道

3. **发消息**
   - 在团队讨论频道发送消息
   - 频道自动激活（出现在频道列表中）

4. **切换回默认频道**
   - 点击频道选择器
   - 选择"默认频道"
   - 系统切换，显示默认频道的消息

5. **其他用户加入**
   - 其他用户登录并选择"团队讨论"频道
   - 可以看到所有历史消息

---

## 常见问题

### Q: 如何删除频道？
A: 频道本身不存储，只是消息的归类标记。使用数据库管理工具清空该频道所有消息即可。

### Q: 能在多个频道同时在线吗？
A: 目前一次只能在一个频道。但可以快速切换频道。

### Q: 频道会被删除吗？
A: 频道名称会一直保留在列表中（只要该频道有消息）。清空所有消息的频道可能消失从列表中消失，但重新发送消息后会再次出现。

### Q: 能修改频道名称吗？
A: 目前不支持修改。如果要改名，需要：
1. 在新频道名发送所有消息
2. 使用数据库管理工具批量更新消息的 channel 字段

---

## 管理员功能

### 数据库管理工具

使用 `db_manager.py` 管理聊天数据：

```bash
python db_manager.py
```

**功能菜单：**
1. 查看所有频道统计
2. 查看消息（所有频道）
3. 查看消息（指定频道）
4. 查看消息（包括已删除的）
5. 软删除所有消息（标记删除 - 界面清空）
6. 软删除指定频道消息
7. 真实删除所有消息（永久删除）
8. 真实删除指定频道消息

**清空频道消息示例：**
```
选择: 6
请输入频道名称 (default): 团队讨论
✅ 已将 15 条频道 '团队讨论' 中所有未删除的消息标记为已删除
```

---

## 后续计划

计划中的功能：
- [ ] 频道加密（密码保护）
- [ ] 频道描述和公告
- [ ] 频道管理员权限
- [ ] 多频道同时在线（分屏显示）
- [ ] 频道搜索和过滤
- [ ] 频道收藏和置顶

---

## 技术细节

### 数据结构

```sql
-- messages 表结构
id INTEGER PRIMARY KEY
content TEXT
user_id INTEGER
channel TEXT DEFAULT 'default'
is_deleted BOOLEAN DEFAULT 0
created_at DATETIME

-- 所有现有消息自动归入 'default' 频道
```

### API 端点

```http
GET /channels              # 获取频道列表
GET /messages?channel=xxx  # 获取指定频道消息
GET /users/online?channel=xxx  # 获取指定频道在线用户

DELETE /messages/all       # 软删除当前频道消息
DELETE /messages/all/force # 真实删除所有消息
```

### WebSocket

```
连接: ws://host/ws/{token}?channel={channel}

发送: MESSAGE:你好

广播: NEW_MESSAGE:用户名:你好:14:30:channel名称
```

---

**开始使用吧！** 🎉
